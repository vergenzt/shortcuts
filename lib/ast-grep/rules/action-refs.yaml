id: action-refs
language: jsonnet

utils:

  referee: &referee
    pattern: sc.Action($ID, $PARAMS)
    has: # a UUID
      stopBy: end
      kind: field
      has:
        kind: fieldname
        regex: ^UUID$
        precedes:
          stopBy: end
          kind: string
          pattern: $UUID

  reference: &reference
    any:
    - pattern: >
        {
          OutputName: $REF_NAME,
          OutputUUID: $UUID,
          Type: 'ActionOutput',
        }
    - pattern: >
        {
          Aggrandizements: $AGGS,
          OutputName: $REF_NAME,
          OutputUUID: $UUID,
          Type: 'ActionOutput',
        }

  referrer: &referrer
    pattern: sc.Action($$$)
    has:
      stopBy: end
      any: [*reference]

rule: #*referee
  pattern: sc.ActionsSeq($ACTIONS_ARR)
  has:
    stopBy: end
    any: [*referee]
    # precedes:
    #   stopBy: end
    #   any: [*referrer]

rewriters:

- id: add-referee-names
  rule:
    any: [*referee]
    precedes:
      stopBy: end
      any: [*referrer]
  transform:
    PARAMS_NO_OUTPUT:
      replace:
        source: $PARAMS
        replace: "\\b(UUID|CustomOutputName): .*\n"
        by: ''
  fix: >-
    sc.Action($ID, name=$REF_NAME, params=$PARAMS_NO_OUTPUT)

- id: rewrite-references
  rule: *reference
  transform:
    AGGS_ARG:
      replace:
        source: $AGGS
        replace: '^'
        by: ', aggs='
  fix: sc.Ref(outputs, $REF_NAME$AGGS_ARG)

# transform:
#   ACTIONS_ARR_WITH_REFS:
#     rewrite:
#       rewriters: [add-referee-names, rewrite-references]
#       source: $ACTIONS_ARR

# fix: >-
#   sc.ActionsSeq($ACTIONS_ARR_WITH_REFS)
