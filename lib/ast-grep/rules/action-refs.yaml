id: action-refs
language: jsonnet

utils:

  referee:
    pattern: sc.Action($ID, $PARAMS)
    has: # a UUID
      stopBy: end
      kind: field
      has:
        stopBy: end
        all:
        - kind: fieldname
          regex: ^UUID$
        - pattern: $UUID

  reference:
    any:
    - pattern: >
        {
          OutputName: $REF_NAME,
          OutputUUID: $UUID,
          Type: 'ActionOutput',
        }
    - pattern: >
        {
          Aggrandizements: $AGGS,
          OutputName: $REF_NAME,
          OutputUUID: $UUID,
          Type: 'ActionOutput',
        }

  referrer:
    pattern: sc.Action($$$)
    has:
      matches: reference
      stopBy: end

# context
rule:
  pattern: sc.ActionsSeq($ACTIONS_ARR)
  has:
    stopBy: end
    all:
    - matches: referee
    - matches: referrer


rewriters:

- id: add-referee-names
  rule:
    matches: referee
    precedes:
      matches: referrer
      stopBy: end
  transform:
    PARAMS_NO_UUID:
      replace:
        source: $PARAMS
        replace: '^\s*UUID: .*\n'
        by: ''
  fix: >-
    sc.Action($ID, name=$REF_NAME, params=$PARAMS)

- id: rewrite-references
  rule:
    matches: reference
  transform:
    AGGS_ARG:
      replace:
        source: $AGGS
        replace: '^'
        by: ', aggs='
  fix: sc.Ref(outputs, $NAME$AGGS_ARG)

transform:
  ACTIONS_ARR_WITH_REFS:
    rewrite:
      rewriters: [add-referee-names, rewrite-references]
      source: '$ACTIONS_ARR'

fix: >-
  sc.ActionsSeq($ACTIONS_ARR_WITH_REFS)
