version: '3'

vars:
  IMPORT_DIR: '{{.HOME}}/Library/Mobile Documents/iCloud~is~workflow~my~workflows/Documents'
  SHORTCUT_PATHS:
    sh: shortcuts run 'List Shortcuts'

tasks:
  all:
    desc: Imports all Apple Shortcuts from your account into `{{.SOURCE_DIR}}`.
    deps:
    - for: { var: SHORTCUT_PATHS, split: "\n", as: SHORTCUT_PATH }
      task: default
      vars:
        SHORTCUT_PATH: '{{.SHORTCUT_PATH}}'

  default:
    desc: Imports a single Apple Shortcut at {{"{{.SHORTCUT_PATH}}"}} into `{{.SOURCE_DIR}}`.
    requires:
      vars: ["SOURCE_DIR", "BUILD_DIR", "SHORTCUT_PATH"]
    # sources:
    # - '{{.IMPORT_PATH}}'
    # generates:
    # - '{{.SOURCE_PATH}}'

    cmds:
    - { silent: true, cmd: 'mkdir -p {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}' }

    # https://github.com/0xilis/libshortcutsign/blob/753da95f42945ea76bc9ac8f5cccdfa31cc300cc/libshortcutsign.m#L330-L388
    # `fq` below is https://github.com/wader/fq.
    - >
      cat {{shellQuote .IMPORT_DIR}}/{{shellQuote .SHORTCUT_PATH}}.shortcut
      | tee {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}.shortcut
      | fq -r -d bytes '.[((.[0x8:0xC] | explode | reverse | tobytes | tonumber) + 0x495c):] | print'
      | lzfse -decode
      | aa extract -d {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}
      &&
      plutil -convert xml1 
      {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}/Shortcut.wflow
      -o 
      {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.plist
      &&
      plutil -convert json 
      {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}/Shortcut.wflow
      -o - | jq --sort-keys .  >
      {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.json
      &&
      {
      {
      {{.HOME}}/code/cherri/cherri
      --import={{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.plist
      2>&1
      &&
      mv
      {{shellQuote (base .SHORTCUT_PATH) }}_decompiled.cherri
      {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.cherri
      ;
      }
      || true;
      }
      | tee {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.cherri-errors.log
    - >
      find
      {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.cherri-errors.log
      -size 0
      -delete
