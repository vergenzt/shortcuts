version: '3'

vars:
  IMPORT_DIR: '{{.HOME}}/Library/Mobile Documents/iCloud~is~workflow~my~workflows/Documents'
  SHORTCUT_PATHS:
    sh: >
      shortcuts run 'Export Shortcuts' &&
      find {{shellQuote .IMPORT_DIR}} -type f -name '*.shortcut' -printf '%P\n'
      | sed 's/\.shortcut$//g'

tasks:
  all:
    desc: Imports all Apple Shortcuts from your account into `{{.SOURCE_DIR}}`.
    deps:
    - for: { var: SHORTCUT_PATHS, split: "\n", as: SHORTCUT_PATH }
      task: default
      vars:
        SHORTCUT_PATH: '{{.SHORTCUT_PATH}}'

  default:
    desc: Imports a single Apple Shortcut at {{"{{.SHORTCUT_PATH}}"}} into `{{.SOURCE_DIR}}`.
    requires:
      vars: ["SOURCE_DIR", "BUILD_DIR", "SHORTCUT_PATH"]
    vars:
      BUILD_PATH: '{{.BUILD_DIR}}/{{.SHORTCUT_PATH}}'
      IMPORT_PATH: '{{.IMPORT_DIR}}/{{.SHORTCUT_PATH}}.shortcut'
      SOURCE_PATH: '{{.SOURCE_DIR}}/{{.SHORTCUT_PATH}}.jsonnet'
    # sources:
    # - '{{.IMPORT_PATH}}'
    # generates:
    # - '{{.SOURCE_PATH}}'

    cmds:
    - { silent: true, cmd: "mkdir -p {{shellQuote .BUILD_PATH}}" }
    - >
      <{{shellQuote .IMPORT_PATH}} fq -r -d bytes '
      (.[0x8:0xC] | explode | reverse | tobytes | tonumber) as $aea_ctx_size |
      ($aea_ctx_size + 0x495c) as $aa_start |
      .[$aa_start:] | print
      '
      | lzfse -decode
      | aa extract -d {{shellQuote .BUILD_PATH}}
      && plutil -convert json {{shellQuote .BUILD_PATH}}/Shortcut.wflow -o -
      | jq --sort-keys '(.WFWorkflowTypes, .WFWorkflowOutputContentItemClasses) |= sort'
      | tee {{shellQuote .BUILD_PATH}}/Shortcut.json
      | jsonnetfmt /dev/stdin
      > {{shellQuote .SOURCE_PATH}}



