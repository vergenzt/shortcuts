version: '3'

vars:
  IMPORT_DIR: '{{.HOME}}/Library/Mobile Documents/iCloud~is~workflow~my~workflows/Documents'
  SHORTCUT_PATHS:
    sh: shortcuts run 'List Shortcuts'

tasks:
  all:
    desc: Imports all Apple Shortcuts from your account into `{{.SOURCE_DIR}}`.
    deps:
    - for: { var: SHORTCUT_PATHS, split: "\n", as: SHORTCUT_PATH }
      task: default
      vars:
        SHORTCUT_PATH: '{{.SHORTCUT_PATH}}'

  default:
    desc: Imports a single Apple Shortcut at {{"{{.SHORTCUT_PATH}}"}} into `{{.SOURCE_DIR}}`.
    requires:
      vars: ["SOURCE_DIR", "BUILD_DIR", "SHORTCUT_PATH"]
    # sources:
    # - '{{.IMPORT_PATH}}'
    # generates:
    # - '{{.SOURCE_PATH}}'

    cmds:
    - { silent: true, cmd: 'mkdir -p {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}' }

    # https://github.com/0xilis/libshortcutsign/blob/753da95f42945ea76bc9ac8f5cccdfa31cc300cc/libshortcutsign.m#L330-L388
    # `fq` below is https://github.com/wader/fq.
    - >
      cat {{shellQuote .IMPORT_DIR}}/{{shellQuote .SHORTCUT_PATH}}.shortcut
      | tee {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}.shortcut
      | fq -r -d bytes '.[((.[0x8:0xC] | explode | reverse | tobytes | tonumber) + 0x495c):] | print'
      | lzfse -decode
      | aa extract -d {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}
      &&
      cat {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}/Shortcut.wflow
      | plutil -convert json -o - -
      | jq --sort-keys '(.WFWorkflowTypes, .WFWorkflowOutputContentItemClasses) |= sort'
      | tee {{shellQuote .BUILD_DIR}}/{{shellQuote .SHORTCUT_PATH}}/Shortcut.json
      | jsonnetfmt /dev/stdin
      > {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.jsonnet

    - >
      while true; do
        sg scan --update-all {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.jsonnet
        jsonnetfmt -i {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.jsonnet || true
        SHA1_PREV=${SHA1_CURR:-}
        SHA1_CURR=$(sha1sum {{shellQuote .SOURCE_DIR}}/{{shellQuote .SHORTCUT_PATH}}.jsonnet)
        test "$SHA1_CURR" = "$SHA1_PREV" && break
      done
